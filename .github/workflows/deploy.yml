name: Deploy to VPS

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Debug - Check secrets are set
              run: |
                  echo "VPS_HOST is set: ${{ secrets.VPS_HOST != '' }}"
                  echo "VPS_USER is set: ${{ secrets.VPS_USER != '' }}"
                  echo "VPS_SSH_KEY is set: ${{ secrets.VPS_SSH_KEY != '' }}"
                  echo "VPS_HOST value: ${{ secrets.VPS_HOST }}"
                  echo "VPS_USER value: ${{ secrets.VPS_USER }}"
                  echo "VPS_SSH_KEY length: ${#VPS_SSH_KEY}"
              env:
                  VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}

            - name: Setup SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/github-action-germ-api
                  chmod 600 ~/.ssh/github-action-germ-api
                  ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy application
              run: |
                  ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
                  cd ~/GERM-scrapper

                  # Récupération des derniers changements
                  git pull origin main

                  # Installation des dépendances
                  npm install

                  # Jouer la migration pour mettre a jour la db
                  npx drizzle-kit push

                  # Redémarrage du service
                  # Tuer l'ancien processus (ignorer l'erreur si aucun processus n'existe)
                  pkill -f "node index.js" || true

                  # Lancer le nouveau processus en arrière-plan avec nohup
                  nohup npm run prod > app.log 2>&1 &
                  EOF
